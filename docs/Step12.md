## âœï¸ ì¡°íšŒ ê¸°ëŠ¥ ë¦¬ìŠ¤íŠ¸ì—…

- í¬ì¸íŠ¸ ì”ì•¡ ì¡°íšŒ
- ë³´ìœ  ì¿ í° ëª©ë¡ ì¡°íšŒ
- ìƒí’ˆ ì¡°íšŒ
- ì¸ê¸° ìƒí’ˆ ì¡°íšŒ

<br>

## â“ ì˜ˆìƒ ë³‘ëª© ì§€ì 

- í¬ì¸íŠ¸ ì”ì•¡ ì¡°íšŒ (âŒ)
    
    - í´ëŸ¬ìŠ¤í„°ë§ ì¸ë±ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ì¡°íšŒí•˜ê¸° ë•Œë¬¸ì— ë§¤ìš° ë¹ ë¥¸ ì¡°íšŒ ê°€ëŠ¥
    - ë³„ë„ë¡œ ê³ ìœ í•œ ì‚¬ìš©ì ì‹ë³„ìë¥¼ ì‚¬ìš©í•œë‹¤ë©´ Unique ì¸ë±ìŠ¤ ì„¤ì •í•˜ì—¬ í•´ê²° (ë°ì´í„° ì¼ê´€ì„± + ì¡°íšŒ ì„±ëŠ¥)
    - e.g. UUID v4 (ğŸ¢) / UUID v7 (ğŸš€)

- ë³´ìœ  ì¿ í° ëª©ë¡ ì¡°íšŒ (âŒ)

    - ë…¼ í´ëŸ¬ìŠ¤í„°ë§ ì¸ë±ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ìƒí’ˆì„ ì¡°íšŒí•˜ê¸° ë•Œë¬¸ì— ë¹ ë¥¸ ì¡°íšŒ ê°€ëŠ¥
    - ë³„ë„ë¡œ ê³ ìœ í•œ ì‚¬ìš©ì ì‹ë³„ìë¥¼ ì‚¬ìš©í•œë‹¤ë©´ Unique ì¸ë±ìŠ¤ ì„¤ì •í•˜ì—¬ í•´ê²° (ë°ì´í„° ì¼ê´€ì„± + ì¡°íšŒ ì„±ëŠ¥)
    - e.g. UUID v4 (ğŸ¢) / UUID v7 (ğŸš€)

- ìƒí’ˆ ì¡°íšŒ (âŒ)

    - í´ëŸ¬ìŠ¤í„°ë§ ì¸ë±ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ì¡°íšŒí•˜ê¸° ë•Œë¬¸ì— ë§¤ìš° ë¹ ë¥¸ ì¡°íšŒ ê°€ëŠ¥
    - ë³„ë„ë¡œ ê³ ìœ í•œ ì‚¬ìš©ì ì‹ë³„ìë¥¼ ì‚¬ìš©í•œë‹¤ë©´ Unique ì¸ë±ìŠ¤ ì„¤ì •í•˜ì—¬ í•´ê²° (ë°ì´í„° ì¼ê´€ì„± + ì¡°íšŒ ì„±ëŠ¥)
    - e.g. UUID v4 (ğŸ¢) / UUID v7 (ğŸš€)

- ì¸ê¸° ìƒí’ˆ ì¡°íšŒ (âœ…)

    - ì£¼ë¬¸ í†µê³„ í…Œì´ë¸”ì—ì„œ ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì— ë³‘ëª©ì´ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ë§¤ìš° ë†’ìŒ

<br>

## ğŸ’¡ ìºì‹± ì ìš©

### ğŸ“Œ ì ìš© ëŒ€ìƒ

- ì¸ê¸° ìƒí’ˆ ì¡°íšŒ API
  - ì¸ê¸° ìƒí’ˆ ì¡°íšŒì˜ ê²½ìš°, ì¼ê°„ìœ¼ë¡œ ê°±ì‹ ë˜ì–´ "ìì£¼ ë³€ê²½ë˜ì§€ ì•ŠëŠ” ë°ì´í„°" ì´ë¯€ë¡œ ìºì‹±ì— ì í•©
  - ìƒí’ˆë³„ ì§‘ê³„ë¥¼ ìœ„í•´ GROUP BY ì—°ì‚°ì„ ì‚¬ìš©í•˜ê³  ì´ë¡œ ì¸í•´ ì„ì‹œ í…Œì´ë¸”ì„ ìƒì„±í•˜ê¸° ë•Œë¬¸ì— ë°ì´í„°ë² ì´ìŠ¤ì— ë§ì€ ë¶€í•˜ ë°œìƒ
  - í™•ì‹¤í•œ ì„±ëŠ¥ ë¹„êµë¥¼ ìœ„í•´ Join ì—°ì‚°ì„ ì œê±°í•˜ì§€ ì•Šê³  ì§„í–‰ (e.g. Join ì—°ì‚° ì œê±° í›„, product_id ì‹ë³„ìë¡œ ì¬ì¡°íšŒ X)
```sql
SELECT
    P.product_id
    , P.name
    , P.price
    , P.quantity
FROM
    ORDER_STATISTICS OS
INNER JOIN
    PRODUCT P
ON 
    OS.product_id = P.product_id
WHERE
    OS.created_at >= '2025-05-01 00:00:00'
GROUP BY
    OS.product_id
ORDER BY
    SUM(OS.quantity) DESC
LIMIT
    10;
```

<br>

### ğŸ”¹ ìºì‹± ì „ëµ

- ì½ê¸° ì „ëµ
    - Read Through ì „ëµì„ í™œìš©í•˜ì—¬ ìºì‹œ ìŠ¤íƒ¬í”¼ë“œ í˜„ìƒ ë°©ì§€
        ```java
        public List<Product> findTopProductsCaching(int limit) {
            String jsonData = redisTemplate.opsForValue()
                    .get("topProducts");
    
            if (jsonData == null) {
                return new ArrayList<>();
            }
            return JsonUtil.fromJson(jsonData, new TypeReference<List<Product>>() {});
        }
        ```

- ì“°ê¸° ì „ëµ
    - Cache Preload ì „ëµì„ í™œìš©í•˜ì—¬ ì£¼ê¸°ì ìœ¼ë¡œ ì¸ê¸° ìƒí’ˆ ë°ì´í„° ê°±ì‹  (ì¼ê°„)
        ```java
        @Scheduled(cron = "0 0 1 * * *")
        public void popularProduct() {
            List<Product> topProducts = productRepository.findTopProducts(10);
            String key = "topProducts";
            String value = JsonUtil.toJson(topProducts);
  
            // ìºì‹œ ì˜¤ë²„ë© êµ¬ê°„ ì„¤ì •
            redisTemplate.opsForValue()
                .set(key, value, Duration.ofHours(25L));
        }
        ```
<br>

## ğŸ“Š BMT ì§„í–‰

### ğŸ›  í…ŒìŠ¤íŠ¸ í™˜ê²½

- MacOS M4 Pro (OS 15.4.1)
- Spring Boot (3.4.1)
- MySQL 8

<br>

### â™»ï¸ ë°ì´í„° ì…‹ì—…

- JPA Stateless Session + Instancio ë¼ì´ë¸ŒëŸ¬ë¦¬ í™œìš©í•˜ì—¬ ìƒí’ˆ, ì£¼ë¬¸, ì£¼ë¬¸í†µê³„ ë°ì´í„° ì…‹ì—… (ì•½ 100ë§Œê±´)

```java
@Slf4j
@Component
@RequiredArgsConstructor
public class BatchComponent {
    private final EntityManagerFactory entityManagerFactory;

    @EventListener(ApplicationReadyEvent.class)
    public void batch() {
        SessionFactory sessionFactory = entityManagerFactory.unwrap(SessionFactory.class);
        StatelessSession statelessSession = sessionFactory.openStatelessSession();
        Transaction tx = statelessSession.beginTransaction();
    
        try {
            for (int i = 1; i < 1_000_000; i++) {
                LocalDateTime start = LocalDateTime.of(2020, 1, 1, 0, 0);
                LocalDateTime end = LocalDateTime.of(2025, 12, 31, 23, 59);
                ProductEntity productEntity = Instancio.of(ProductEntity.class)
                        .set(field(ProductEntity::getProductId), (long) i)
                        .generate(field(ProductEntity::getName), gen -> gen.string().prefix("ìƒí’ˆ").length(20))
                        .generate(field(ProductEntity::getPrice), gen -> gen.longs().min(10000L).max(300000L))
                        .generate(field(ProductEntity::getQuantity), gen -> gen.ints().min(10).max(30))
                        .generate(field(ProductEntity::getCreatedAt), gen -> gen.temporal().localDateTime().range(start, end))
                        .create();
        
                statelessSession.insert(productEntity);
            }
            tx.commit();
        } catch (Exception e) {
            tx.rollback();
            throw e;
        } finally {
            statelessSession.close();
        }
    }
}
```

<br>

### ğŸ“ˆ ìºì‹± ì ìš©ì „

- í†°ìº£ ì„œë²„ê°€ 1ëŒ€ì´ë¯€ë¡œ ë™ì‹œ ìš”ì²­ì€ DB ì»¤ë„¥ì…˜í’€ ê°œìˆ˜ ì´í•˜ë¡œ ì„¤ì •í•˜ì—¬ ì§„í–‰

| Concurrency | Total Requests | Min Latency (ms) | Max Latency (ms) | Avg Latency (ms) |
|:-----------:|:--------------:|:----------------:|:----------------:|:----------------:|
|      3      |       3        |       9120       |       9204       |       9179       |
|      3      |       6        |       9295       |      18418       |      13307       |
|      3      |       9        |       9187       |      27634       |      18440       |

<br>

### ğŸ“‰ ìºì‹± ì ìš©í›„

| Concurrency | Total Requests | Min Latency (ms) | Max Latency (ms) | Avg Latency (ms) |
|:-----------:|:--------------:|:----------------:|:----------------:|:----------------:|
|      3      |       3        |        34        |        36        |        35        |
|      3      |       6        |        35        |        36        |        35        |
|      3      |       9        |        34        |        37        |        35        |

<br>


## ğŸ” ê²°ë¡ 

- Redis ê¸°ë°˜ì˜ ìºì‹± ì „ëµì„ ë„ì…í•¨ìœ¼ë¡œì¨ API ì‘ë‹µ ì‹œê°„ì„ íšê¸°ì ìœ¼ë¡œ ë‹¨ì¶•í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

- Redis ì„œë²„ë¥¼ Master-Slave êµ¬ì¡°ë¡œ ìš´ì˜í•  ë•Œ, íŠ¸ë˜í”½ì´ ì¦ê°€í• ìˆ˜ë¡ ë§ˆìŠ¤í„° ë…¸ë“œì— ë¶€í•˜ê°€ ì§‘ì¤‘ë˜ê¸° ë•Œë¬¸ì— ì´ë¥¼ í•´ì†Œí•˜ê¸° ìœ„í•œ
  Redis í´ëŸ¬ìŠ¤í„° êµ¬ì„±ì„ ìƒê°í•´ë´¤ìŠµë‹ˆë‹¤. (ì˜¨í”„ë ˆë¯¸ìŠ¤ ê¸°ì¤€)

- ë‹¤ë§Œ, Redis í´ëŸ¬ìŠ¤í„° êµ¬ì„±ì€ ì¸í”„ë¼ ë³µì¡ë„ê°€ ì¦ê°€í•˜ë¯€ë¡œ ë¡œì»¬ ìºì‹œë¥¼ í™œìš©í•œ 2ê³„ì¸µ ìºì‹œ ì „ëµ (2-Layered Caching)ì„ ì ìš©í•˜ë©´
  ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

- ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œ Redis ì„œë²„ë¥¼ êµ¬ì¶•í•  ì‹œ, ì ì ˆí•œ maxmemory, maxmemory-policy ì˜µì…˜ì„ ì„¤ì •í•˜ì—¬ OOM ì´ìŠˆë¥¼ ë°©ì§€í•´ì•¼í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.
